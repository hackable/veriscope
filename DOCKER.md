# Docker Setup Guide for Veriscope

This document provides comprehensive instructions for running Veriscope using Docker containers.

## Overview

The Veriscope project uses Docker to containerize the entire application stack, including:
- Laravel Trust Anchor Dashboard (PHP 8.3 + Nginx)
- Node.js Trust Anchor Service
- Nethermind Ethereum Node
- PostgreSQL Database
- Redis Server (with RedisBloom module)
- Job Queue (Horizon)
- WebSocket Server

## Prerequisites

### Required Software
- Docker Engine 20.10 or later
- Docker Compose (bundled with Docker Desktop)
- Git
- At least 8GB RAM available for Docker
- 50GB free disk space

### System Requirements
- Ubuntu 22.04 or later (recommended)
- macOS 11+ with Docker Desktop
- Windows 10/11 with WSL2 and Docker Desktop

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│ veriscope/1.0 Container (systemd-ubuntu:22.04)             │
│                                                             │
│  ├─ Nginx (Port 80, 443)                                   │
│  ├─ PHP 8.3 FPM                                            │
│  ├─ Laravel Application (/opt/veriscope/veriscope_ta_dashboard) │
│  ├─ Node.js Service (/opt/veriscope/veriscope_ta_node)    │
│  ├─ PostgreSQL 12                                          │
│  ├─ Redis + RedisBloom                                     │
│  ├─ Nethermind Ethereum Node                              │
│  └─ Laravel Horizon (Queue Worker)                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Quick Start

### 1. Clone the Repository

```bash
git clone <repository-url>
cd veriscope
```

### 2. Configure Environment Variables

Create and configure the main `.env` file:

```bash
cp .env.example .env
```

Edit `.env` and set the following **mandatory** variables:

```env
VERISCOPE_SERVICE_HOST=your-domain.example.com
VERISCOPE_COMMON_NAME="Your Organization Name"
VERISCOPE_TARGET=veriscope_testnet  # or fed_testnet, fed_mainnet
```

### 3. Build the Docker Image

```bash
docker-compose build
```

This builds the `veriscope/1.0` image with all dependencies.

### 4. Start the Container

```bash
docker-compose up -d
```

### 5. Run Initial Setup

Enter the container and run the setup script:

```bash
docker exec -it veriscope_laravel.test_1 bash
cd /opt/veriscope
sudo ./scripts/setup-vasp.sh
```

Follow the interactive menu to install all components (option `i`).

## Docker Configuration

### docker-compose.yml

The main Docker Compose configuration includes:

#### Service: `laravel.test`
- **Image**: `veriscope/1.0`
- **Base Image**: `jrei/systemd-ubuntu:22.04`
- **Privileged Mode**: Required for systemd
- **Ports**:
  - `80`: HTTP (redirects to HTTPS)
  - `443`: HTTPS (Nginx + Laravel)
  - `6001`: WebSocket Server (Laravel WebSockets)
- **Volumes**:
  - `./:/opt/veriscope` - Project source code
  - `/sys/fs/cgroup:/sys/fs/cgroup:ro` - Required for systemd

### Dockerfile

Located at: `/Dockerfile`

**Base Image**: `jrei/systemd-ubuntu:22.04`

**Key Features**:
- Full systemd support for managing services
- Service user setup (UID 1000, GID 1000)
- Automatic execution of setup script on build
- Exposed ports: 80, 443

## Development Dockerfile

Located at: `/veriscope_ta_dashboard/docker/8.0/Dockerfile`

**Purpose**: Development environment with all PHP extensions and build tools

**Base Image**: `ubuntu:22.04`

**Installed Components**:
- PHP 8.3 with extensions (see below)
- Composer (PHP package manager)
- Node.js LTS + Yarn
- MySQL client

### PHP 8.3 Extensions Included:
```
php8.3-cli      php8.3-dev      php8.3-apcu     php8.3-bcmath
php8.3-curl     php8.3-imap     php8.3-gd       php8.3-igbinary
php8.3-imagick  php8.3-intl     php8.3-ldap     php8.3-mbstring
php8.3-msgpack  php8.3-mysql    php8.3-pgsql    php8.3-readline
php8.3-redis    php8.3-sqlite3  php8.3-soap     php8.3-xdebug
php8.3-xml      php8.3-yaml     php8.3-zip
```

## Environment Configuration

### Main Environment File (.env)

**Critical Variables**:

```env
# Service Configuration
VERISCOPE_SERVICE_HOST=node.example.com
VERISCOPE_COMMON_NAME="Example Organization"
VERISCOPE_TARGET=veriscope_testnet

# Target Options:
# - veriscope_testnet: Veriscope test network
# - fed_testnet: Federation test network
# - fed_mainnet: Federation mainnet (production)
```

### Laravel Environment (.env in veriscope_ta_dashboard)

Auto-generated during setup. Key settings:

```env
APP_NAME="Veriscope TA Dashboard"
APP_ENV=local
APP_URL=https://your-domain.com
APP_DEBUG=true

DB_CONNECTION=pgsql
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=trustanchor
DB_USERNAME=trustanchor
DB_PASSWORD=<auto-generated>

CACHE_DRIVER=redis
QUEUE_CONNECTION=redis
SESSION_DRIVER=database

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
```

## Container Management

### Starting Services

```bash
# Start in background
docker-compose up -d

# Start with logs
docker-compose up

# Start specific service
docker-compose up -d laravel.test
```

### Stopping Services

```bash
# Stop all services
docker-compose down

# Stop and remove volumes (⚠️ data loss)
docker-compose down -v
```

### Viewing Logs

```bash
# All logs
docker-compose logs

# Follow logs
docker-compose logs -f

# Specific service logs
docker-compose logs -f laravel.test

# Inside container - systemd services
docker exec -it veriscope_laravel.test_1 journalctl -fu nethermind
docker exec -it veriscope_laravel.test_1 journalctl -fu ta
docker exec -it veriscope_laravel.test_1 journalctl -fu ta-node-1
```

### Accessing the Container

```bash
# Interactive bash shell
docker exec -it veriscope_laravel.test_1 bash

# Run command as service user
docker exec -it veriscope_laravel.test_1 su - serviceuser
```

### Restarting Services Inside Container

```bash
docker exec -it veriscope_laravel.test_1 bash

# Restart all services
systemctl restart nethermind ta ta-wss ta-schedule ta-node-1 nginx postgresql redis-server horizon

# Check service status
systemctl status nethermind ta ta-wss ta-schedule ta-node-1 nginx postgresql redis-server horizon

# Individual service restart
systemctl restart nginx
systemctl restart php8.3-fpm
```

## Service Ports

| Port | Service | Description |
|------|---------|-------------|
| 80 | HTTP | Redirects to HTTPS |
| 443 | HTTPS | Nginx + Laravel Dashboard |
| 6001 | WebSocket | Laravel WebSockets |
| 8545 | Nethermind RPC | Ethereum JSON-RPC (internal) |
| 30303 | Nethermind P2P | Peer discovery (internal) |
| 5432 | PostgreSQL | Database (internal) |
| 6379 | Redis | Cache/Queue (internal) |
| 8080 | Arena | Bull Queue Dashboard (internal) |

**Note**: Only ports 80, 443, and 6001 are exposed to the host.

## Volume Mounts

### Source Code Mount
```yaml
- '.:/opt/veriscope'
```
- **Purpose**: Live code updates during development
- **Type**: Bind mount
- **Permissions**: Owned by service user (UID 1000)

### cgroup Mount (Required for systemd)
```yaml
- '/sys/fs/cgroup:/sys/fs/cgroup:ro'
```
- **Purpose**: systemd process management
- **Type**: Read-only bind mount
- **Required**: Yes (for systemd operation)

## Building Images

### Production Image

```bash
# Build main application image
docker-compose build

# Build without cache
docker-compose build --no-cache

# Build with specific tag
docker build -t veriscope/1.0:latest -f Dockerfile .
```

### Development Image

```bash
# Build development image
cd veriscope_ta_dashboard/docker/8.0
docker build -t veriscope/dev:php8.3 .
```

## Updating Dependencies

### Update PHP Dependencies

```bash
docker exec -it veriscope_laravel.test_1 bash
cd /opt/veriscope/veriscope_ta_dashboard
su serviceuser -c "composer update"
```

### Update Node.js Dependencies

```bash
docker exec -it veriscope_laravel.test_1 bash

# Dashboard dependencies
cd /opt/veriscope/veriscope_ta_dashboard
su serviceuser -c "npm install"

# Node service dependencies
cd /opt/veriscope/veriscope_ta_node
su serviceuser -c "npm install"
```

### Rebuild Frontend Assets

```bash
docker exec -it veriscope_laravel.test_1 bash
cd /opt/veriscope/veriscope_ta_dashboard
su serviceuser -c "npm run production"
```

## Database Management

### Run Migrations

```bash
docker exec -it veriscope_laravel.test_1 bash
cd /opt/veriscope/veriscope_ta_dashboard
su serviceuser -c "php artisan migrate"
```

### Database Backup

```bash
docker exec -it veriscope_laravel.test_1 bash
su postgres -c "pg_dump trustanchor > /opt/veriscope/backup-$(date +%Y%m%d).sql"
```

### Database Restore

```bash
docker exec -it veriscope_laravel.test_1 bash
su postgres -c "psql trustanchor < /opt/veriscope/backup-YYYYMMDD.sql"
```

## SSL/TLS Certificates

Certificates are managed by Let's Encrypt (certbot) inside the container.

### Initial Certificate Setup

The setup script automatically obtains certificates using certbot:

```bash
docker exec -it veriscope_laravel.test_1 bash
cd /opt/veriscope
sudo ./scripts/setup-vasp.sh
# Choose option 4: Obtain/renew SSL certificate
```

### Manual Certificate Renewal

```bash
docker exec -it veriscope_laravel.test_1 bash
systemctl stop nginx
certbot renew
systemctl start nginx
```

### Certificate Locations

- Certificate: `/etc/letsencrypt/live/$VERISCOPE_SERVICE_HOST/fullchain.pem`
- Private Key: `/etc/letsencrypt/live/$VERISCOPE_SERVICE_HOST/privkey.pem`

## Troubleshooting

### Container Won't Start

```bash
# Check logs
docker-compose logs

# Check Docker daemon
sudo systemctl status docker

# Check available resources
docker system df
docker system prune  # Clean up if needed
```

### Service Fails Inside Container

```bash
# Check service status
docker exec -it veriscope_laravel.test_1 systemctl status <service-name>

# View service logs
docker exec -it veriscope_laravel.test_1 journalctl -u <service-name> -n 50

# Restart service
docker exec -it veriscope_laravel.test_1 systemctl restart <service-name>
```

### Permission Issues

```bash
# Fix ownership
docker exec -it veriscope_laravel.test_1 bash
chown -R serviceuser:www-data /opt/veriscope/veriscope_ta_dashboard
chmod -R 0770 /opt/veriscope/veriscope_ta_dashboard/storage
```

### Database Connection Issues

```bash
# Check PostgreSQL is running
docker exec -it veriscope_laravel.test_1 systemctl status postgresql

# Check database exists
docker exec -it veriscope_laravel.test_1 su postgres -c "psql -l"

# Test connection
docker exec -it veriscope_laravel.test_1 su postgres -c "psql trustanchor"
```

### Port Already in Use

```bash
# Find what's using port 80/443
sudo lsof -i :80
sudo lsof -i :443

# Change ports in docker-compose.yml
ports:
  - '8080:80'
  - '8443:443'
```

### Nethermind Won't Sync

```bash
# Check Nethermind logs
docker exec -it veriscope_laravel.test_1 journalctl -u nethermind -f

# Check configuration
docker exec -it veriscope_laravel.test_1 cat /opt/nm/config.cfg

# Refresh static nodes
docker exec -it veriscope_laravel.test_1 bash
cd /opt/veriscope
sudo ./scripts/setup-vasp.sh
# Choose option 8: Update static node list
```

### Redis Connection Issues

```bash
# Check Redis is running
docker exec -it veriscope_laravel.test_1 systemctl status redis-server

# Test Redis connection
docker exec -it veriscope_laravel.test_1 redis-cli ping

# Check RedisBloom module loaded
docker exec -it veriscope_laravel.test_1 redis-cli MODULE LIST
```

## Performance Tuning

### Increase PHP Memory Limit

Edit `/opt/veriscope/veriscope_ta_dashboard/docker/8.0/php.ini`:

```ini
memory_limit = 512M
```

Rebuild the image.

### Optimize PHP-FPM

```bash
docker exec -it veriscope_laravel.test_1 bash
vi /etc/php/8.3/fpm/pool.d/www.conf

# Adjust these values based on your resources:
pm = dynamic
pm.max_children = 50
pm.start_servers = 10
pm.min_spare_servers = 5
pm.max_spare_servers = 20

systemctl restart php8.3-fpm
```

### PostgreSQL Tuning

```bash
docker exec -it veriscope_laravel.test_1 bash
vi /etc/postgresql/12/main/postgresql.conf

# Adjust based on available RAM:
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 4MB

systemctl restart postgresql
```

## Backup and Restore

### Full Backup Script

```bash
#!/bin/bash
BACKUP_DIR="/opt/veriscope/backups/$(date +%Y%m%d)"

docker exec veriscope_laravel.test_1 bash -c "
    mkdir -p $BACKUP_DIR

    # Database backup
    su postgres -c 'pg_dump trustanchor > $BACKUP_DIR/database.sql'

    # Laravel storage
    tar -czf $BACKUP_DIR/storage.tar.gz /opt/veriscope/veriscope_ta_dashboard/storage

    # Nethermind data
    tar -czf $BACKUP_DIR/nethermind.tar.gz /opt/nm/nethermind_db

    # Environment files
    cp /opt/veriscope/.env $BACKUP_DIR/
    cp /opt/veriscope/veriscope_ta_dashboard/.env $BACKUP_DIR/dashboard.env
    cp /opt/veriscope/veriscope_ta_node/.env $BACKUP_DIR/node.env
"

echo "Backup completed: $BACKUP_DIR"
```

## Security Best Practices

1. **Don't expose internal ports** - Only expose necessary ports (80, 443, 6001)
2. **Use secrets** - Store sensitive data in Docker secrets or encrypted files
3. **Regular updates** - Keep base images and dependencies updated
4. **Scan images** - Use `docker scan` to check for vulnerabilities
5. **Limit privileges** - Run services as non-root user when possible
6. **Network isolation** - Use Docker networks to isolate services
7. **Read-only mounts** - Use `:ro` flag where appropriate
8. **Resource limits** - Set memory and CPU limits in docker-compose.yml

### Example with Resource Limits

```yaml
services:
  laravel.test:
    image: veriscope/1.0
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
```

## Upgrading

### Upgrade to New Version

```bash
# Pull latest code
git pull origin main

# Rebuild image
docker-compose build --no-cache

# Stop current container
docker-compose down

# Start new container
docker-compose up -d

# Run migrations inside container
docker exec -it veriscope_laravel.test_1 bash
cd /opt/veriscope/veriscope_ta_dashboard
su serviceuser -c "php artisan migrate"
```

### Upgrade PHP Version

This has been completed (PHP 8.3). To verify:

```bash
docker exec -it veriscope_laravel.test_1 php -v
```

## Development Workflow

### Live Coding

Changes to code in the mounted volume are immediately available:

```bash
# Edit files locally
vim veriscope_ta_dashboard/app/Http/Controllers/HomeController.php

# Changes are immediately reflected (for PHP)
# For frontend assets, rebuild:
docker exec -it veriscope_laravel.test_1 bash
cd /opt/veriscope/veriscope_ta_dashboard
su serviceuser -c "npm run development"
```

### Running Tests

```bash
docker exec -it veriscope_laravel.test_1 bash
cd /opt/veriscope/veriscope_ta_dashboard

# PHP tests
su serviceuser -c "php artisan test"

# JavaScript tests
su serviceuser -c "npm run test-js"
```

### Debug Mode

Enable debug mode in `.env`:

```env
APP_DEBUG=true
APP_ENV=local
```

View detailed error messages in browser and logs.

## Production Deployment

### Production Checklist

- [ ] Set `APP_ENV=production` in `.env`
- [ ] Set `APP_DEBUG=false` in `.env`
- [ ] Use strong database passwords
- [ ] Configure SSL certificates
- [ ] Set up automated backups
- [ ] Configure log rotation
- [ ] Set up monitoring (optional)
- [ ] Enable firewall rules
- [ ] Review security settings
- [ ] Test disaster recovery

### Production Environment Variables

```env
APP_ENV=production
APP_DEBUG=false
LOG_LEVEL=warning
SESSION_SECURE_COOKIE=true
```

## Additional Resources

- [Docker Documentation](https://docs.docker.com/)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [Laravel Documentation](https://laravel.com/docs)
- [Nethermind Documentation](https://docs.nethermind.io/)

## Support

For issues or questions:
1. Check the Troubleshooting section above
2. Review container logs: `docker-compose logs`
3. Check service status inside container
4. Consult project documentation

---

**Version**: 4.5.0
**Last Updated**: 2025-11-10
**Docker Image**: veriscope/1.0
**Base OS**: Ubuntu 22.04
**PHP Version**: 8.3
**Python Version**: 3.11
